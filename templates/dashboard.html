<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/welcome.css') }}">
    <title>Dashboard - Mi ETIB</title>
</head>
<body>
    <!-- POPUP OVERLAY DE BIENVENIDA - Se muestra encima del dashboard -->
    <div class="welcome-overlay" id="welcomeOverlay">
        <div class="welcome-popup" id="welcomePopup">
            <div class="popup-logo">
                <div class="logo-e">e</div>
                <span class="logo-text">etib</span>
            </div>
            
            <div class="popup-header">
                <div class="success-icon">‚úì</div>
                <h2>¬°Bienvenido al Sistema!</h2>
            </div>
            
            <div class="popup-content">
                <div class="user-greeting">
                    <h3>Hola, <span class="username">{{ username }}</span></h3>
                    <p>Has iniciado sesi√≥n exitosamente en MI ETIB</p>
                </div>
                
                <div class="system-info">
                    <p><strong>Sistema:</strong> MI ETIB v13.06.2025</p>
                    <p><strong>Hora de acceso:</strong> <span id="currentTime"></span></p>
                </div>
            </div>
            
            <div class="popup-actions">
                <button class="continue-btn" id="closePopup">Continuar al Dashboard</button>
            </div>
            
            <div class="countdown" id="countdown"></div>
            <div class="countdown-bar"></div>
        </div>
    </div>

    <!-- POPUP DE ESTAD√çSTICAS MENSUALES -->
    <div class="stats-overlay" id="statsOverlay" style="display: none;">
        <div class="stats-popup" id="statsPopup">
            <div class="stats-header">
                <div class="stats-icon">üìä</div>
                <h2>¬°Excelente Trabajo!</h2>
            </div>
            
            <div class="stats-content">
                <p class="stats-message" id="statsMessage">
                    Gracias a empleados como t√∫, ETIB mantiene 
                    <span class="punctuality-percent" id="punctualityPercent">95</span>% de puntualidad
                </p>
                <div class="stats-visual">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text">
                        <span id="progressText">Excelencia Operacional</span>
                    </div>
                </div>
                <p class="stats-subtitle">¬°Sigues siendo parte del √©xito de ETIB!</p>
            </div>
            
            <button class="stats-close-btn" id="closeStatsPopup">¬°Entendido!</button>
        </div>
    </div>

    <!-- DASHBOARD - Se muestra detr√°s del popup inicialmente -->
    <div class="dashboard-container">
        <!-- Header superior -->
        <header class="top-header">
            <div class="header-left">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Crect width='40' height='40' fill='%23007bff'/%3E%3C/svg%3E" alt="Logo" class="header-logo">
            </div>
            <div class="header-right">
                <a href="{{ url_for('logout') }}" class="power-button" title="Cerrar Sesi√≥n">
                    <div class="power-icon"></div>
                </a>
                <div class="user-info">
                    <span class="user-name">{{ username }}</span>
                    <div class="user-avatar">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Ccircle cx='20' cy='20' r='20' fill='%23ddd'/%3E%3Ccircle cx='20' cy='15' r='8' fill='%23999'/%3E%3Cpath d='M5 35c0-8 7-15 15-15s15 7 15 15' fill='%23999'/%3E%3C/svg%3E" alt="Avatar">
                    </div>
                </div>
            </div>
        </header>

        <div class="main-layout">
            <!-- Sidebar izquierdo -->
            <aside class="sidebar">
                <nav class="sidebar-nav">
                    <div class="nav-item">
                        <div class="nav-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                            </svg>
                        </div>
                        <span class="nav-text">Control General</span>
                    </div>

                    <div class="nav-item">
                        <div class="nav-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A2 2 0 0 0 18 7h-2c-.83 0-1.54.5-1.85 1.22L11.09 16H8.5c-.28 0-.5.22-.5.5s.22.5.5.5h3.09l1.41-3.5h2.82L18 20h2z"/>
                            </svg>
                        </div>
                        <span class="nav-text">Gesti√≥n Humana</span>
                    </div>

                    <div class="nav-item">
                        <div class="nav-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                        </div>
                        <span class="nav-text">Operacional</span>
                    </div>

                    <div class="nav-item">
                        <div class="nav-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                            </svg>
                        </div>
                        <span class="nav-text">Comunicaci√≥n</span>
                    </div>

                    <div class="nav-item">
                        <div class="nav-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V9h10v2zm-4 4H9v-2h6v2zm4-8H9V5h10v2z"/>
                            </svg>
                        </div>
                        <span class="nav-text">Aplicativos</span>
                    </div>

                    <div class="nav-item">
                        <div class="nav-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                            </svg>
                        </div>
                        <span class="nav-text">Tutoriales</span>
                    </div>

                    <div class="nav-item">
                        <div class="nav-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                        </div>
                        <span class="nav-text">Comit√©s</span>
                    </div>

                    <div class="nav-item">
                        <div class="nav-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9 11H7v9h2v-9zm4 0h-2v9h2v-9zm4 0h-2v9h2v-9zm2-7h-3V2h-2v2H8V2H6v2H3v2h18V4z"/>
                            </svg>
                        </div>
                        <span class="nav-text">Encuestas</span>
                    </div>

                    <div class="nav-item">
                        <div class="nav-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                        </div>
                        <span class="nav-text">Evaluaci√≥n</span>
                    </div>

                    <div class="nav-item">
                        <div class="nav-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
                            </svg>
                        </div>
                        <span class="nav-text">Reglamento Interno de Trabajo</span>
                    </div>
                </nav>
            </aside>

            <!-- Contenido principal -->
            <main class="main-content">
                <div class="content-area">
                    <div class="welcome-message">
                        <h1>¬°Bienvenid@ de vuelta, {{ username }}!</h1>
                        <p>Explora todo lo que nos une en ETIB.</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar hora actual
            const now = new Date();
            const timeString = now.toLocaleDateString('es-ES', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeString;

            // Variables para el popup de bienvenida
            const overlay = document.getElementById('welcomeOverlay');
            const popup = document.getElementById('welcomePopup');
            const closeBtn = document.getElementById('closePopup');
            const countdownElement = document.getElementById('countdown');
            
            // Timer de countdown
            let countdown = 50000;

            // Mostrar popup con animaci√≥n
            setTimeout(() => {
                popup.style.transform = 'scale(1)';
                popup.style.opacity = '1';
            }, 100);

            // Funci√≥n para cerrar popup de bienvenida
            function closeWelcomePopup() {
                overlay.style.opacity = '0';
                overlay.style.visibility = 'hidden';
                popup.style.transform = 'scale(0.8)';
                
                // Verificar popup mensual despu√©s de cerrar el de bienvenida
                setTimeout(checkMonthlyPopup, 1000);
            }

            // Funci√≥n para actualizar countdown
            function updateCountdown() {
                if (countdown > 0) {
                    countdownElement.textContent = `Cerrando autom√°ticamente en ${countdown} segundos...`;
                    countdown--;
                    setTimeout(updateCountdown, 1000);
                } else {
                    closeWelcomePopup();
                }
            }

            // Iniciar countdown
            updateCountdown();

            // Cerrar con bot√≥n
            closeBtn.addEventListener('click', closeWelcomePopup);

            // Cerrar con click fuera del popup
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    closeWelcomePopup();
                }
            });

            // Cerrar con tecla Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeWelcomePopup();
                }
            });

            // FUNCIONES PARA EL POPUP MENSUAL DE ESTAD√çSTICAS
            async function checkMonthlyPopup() {
                try {
                    const response = await fetch('/check_monthly_popup');
                    const data = await response.json();
                    
                    if (data.show) {
                        showStatsPopup(data.punctuality, data.message);
                    }
                } catch (error) {
                    console.log('Error checking monthly popup:', error);
                }
            }

            function showStatsPopup(punctuality, message) {
                const statsOverlay = document.getElementById('statsOverlay');
                const statsPopup = document.getElementById('statsPopup');
                const percentElement = document.getElementById('punctualityPercent');
                const messageElement = document.getElementById('statsMessage');
                const progressFill = document.getElementById('progressFill');
                const closeStatsBtn = document.getElementById('closeStatsPopup');
                
                // Configurar datos
                percentElement.textContent = punctuality;
                messageElement.innerHTML = message.replace(punctuality + '%', `<span class="punctuality-percent">${punctuality}%</span>`);
                
                // Mostrar popup
                statsOverlay.style.display = 'flex';
                setTimeout(() => {
                    statsPopup.style.transform = 'scale(1)';
                    statsPopup.style.opacity = '1';
                    
                    // Animar barra de progreso
                    setTimeout(() => {
                        progressFill.style.width = punctuality + '%';
                    }, 500);
                }, 100);
                
                // Cerrar popup
                closeStatsBtn.addEventListener('click', closeStatsPopup);
                
                // Cerrar con click fuera del popup
                statsOverlay.addEventListener('click', function(e) {
                    if (e.target === statsOverlay) {
                        closeStatsPopup();
                    }
                });
            }

            async function closeStatsPopup() {
                const statsOverlay = document.getElementById('statsOverlay');
                const statsPopup = document.getElementById('statsPopup');
                
                // Marcar como mostrado en el servidor
                try {
                    await fetch('/mark_popup_shown', { method: 'POST' });
                } catch (error) {
                    console.log('Error marking popup as shown:', error);
                }
                
                // Cerrar con animaci√≥n
                statsPopup.style.transform = 'scale(0.8)';
                statsPopup.style.opacity = '0';
                
                setTimeout(() => {
                    statsOverlay.style.display = 'none';
                }, 400);
            }
        });
    </script>
</body>
</html>